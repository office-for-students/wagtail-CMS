<script>
	function openDropdown() {
	  document.getElementById("myDropdown").classList.toggle("show");
	  document.getElementById("institutionSearchBar").focus();
	  document.getElementById("institutionDropdown").classList.toggle("dropdown-border")
	  document.getElementById("dropdownChevron").classList.toggle("rotate")
	}

	var list = []

	function dropdownName(id, checked) {
		var dropdown = document.getElementById("institutionDropdown");
		
		if(checked && list.includes(id) == false && id !== 'selectAllInstitutions'){
			list.push(id)
		}
		else if(checked == false && list.includes(id)){
			const index = list.indexOf(id);
			list.splice(index, 1);
		}

		list.sort()
		
		if(list.length == 0){
			dropdown.innerHTML = "Institution name"
		}
		else if(list.length < 3){
			dropdown.innerHTML = list
		}
		else if(2 < list.length){
			dropdown.innerHTML = list.length + " options selected"
		}
	}

	function dropdownLoad(){
		var dropdown = document.getElementById("institutionDropdown");
		var institutions = '{{filter_form.institutions}}'.split('#')
		if(institutions){
			for (i = 0; i < institutions.length; i++ ){
            	list.push(institutions[i])
        	}
		}

		if(list[0].length < 2){
			list.pop()
		}

		if(list.length == 0){
			dropdown.innerHTML = "Institution name"
		}
		else if(list.length < 3){
			dropdown.innerHTML = list
		}
		else if(2 < list.length){
			dropdown.innerHTML = list.length + " options selected"
		}
	}

	function selectAll(source) {
	  var aInputs = document.getElementsByTagName('input');
        for (var i=0;i<aInputs.length;i++) {
            if (aInputs[i] != source && aInputs[i].className == source.className && aInputs[i].offsetWidth !== 0) {
            	if(source.checked){  
            		list.push(aInputs[i].id)
            	}
            	else{
            		const index = list.indexOf(aInputs[i].id);
            		list.splice(index, 1);
            	}
                aInputs[i].checked = source.checked;
            }
	    }
	}
</script>

<script>
    function searchList() {
      // Declare variables
      var input, filter, institutions, label, i, txtValue;
      input = document.getElementById("institutionSearchBar");
      filter = input.value.toUpperCase();
      institutions = document.getElementsByClassName("institution-check");
      block = document.getElementById("myDropdown");

      // Loop through all table rows, and hide those who don't match the search query
      for (i = 0; i < institutions.length; i++) {
        label = institutions[i].getElementsByTagName("label")[0];
        if (label) {
          txtValue = label.textContent || label.innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            institutions[i].style.display = "block";
          } else {
            institutions[i].style.display = "none";
          }
          if (txtValue.toUpperCase().indexOf(filter).length < 5){
            block.style.overflowY = "hidden"
          }
        }
      }
    }
</script>

<style>
.show {display:block;}
.dropdown-border{border: 3px solid #c1dfff}
.rotate{transform: rotate(180deg); top:20%;}
</style>

<div class="dropdown">
	<div onclick="openDropdown()" style="display: flex;">
	<div id="institutionDropdown" class="dropdown-dropbtn">
		<p>Institution name</p>	
	</div>
	<div id="dropdownChevron" class="dropdown-chevron"></div>
	</div>
	<script>
		dropdownLoad()
	</script>
	<div id="myDropdown" class="dropdown-content">
		<input type="text" id="institutionSearchBar" onkeyup="searchList()" placeholder="Search..." class="filters-block__filter-search">
		<div class='dropdown-content-select-all-check'>
	    	<input id='selectAllInstitutions' class="inst-check" onclick="selectAll(this); dropdownName(id, checked)" type='checkbox'></input>
	    	<label class="dropdown-content-institution-check-institution-label" id="selectAll-check" for="selectAllInstitutions">Select all institutions</label>
    	</div>
		{% for option in options %}
			{% if option.name in institution_array %}
				<div class="dropdown-content-institution-check institution-check">
			    	<input id='{{option.name}}' onclick="dropdownName(id, checked)" class="inst-check" name='institution_query' value="{{option.name}}" type='checkbox' checked></input>
			    	<label class="dropdown-content-institution-check-institution-label" id="{{option.name}}-label" for="{{option.name}}">{{option.name}}</label>
		    	</div>
		    {% endif %}
		{% endfor %}
		{% for option in options %}
			{% if option.name in institution_array %}
			{% else %}
				<div class="dropdown-content-institution-check institution-check">
			    	<input id='{{option.name}}' onclick="dropdownName(id, checked)" class="inst-check" name='institution_query' value="{{option.name}}" type='checkbox'></input>
			    	<label class="dropdown-content-institution-check-institution-label" id="{{option.name}}-label" for="{{option.name}}">{{option.name}}</label>
		    	</div>
		    {% endif %}
		{% endfor %}
	</div>
</div>
